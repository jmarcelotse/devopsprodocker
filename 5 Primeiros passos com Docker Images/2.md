# OverlayFS na Pr√°tica
O **OverlayFS** √© um sistema de arquivos empilhado usado para combinar diferentes sistemas de arquivos em camadas, permitindo que o sistema de arquivos superior (o "overlay") pare√ßa ser uma √∫nica unidade l√≥gica. No contexto do Docker e cont√™ineres, ele √© amplamente utilizado para criar imagens baseadas em camadas, tornando o uso de armazenamento mais eficiente.

Abaixo, exploraremos o OverlayFS com exemplos pr√°ticos, desde seu funcionamento b√°sico at√© sua aplica√ß√£o em ambientes Docker.

# 1. O Que √© OverlayFS?
- **Empilhamento de Sistemas de Arquivos**:
 - Combina um sistema de arquivos "inferior" (read-only) com um "superior" (read-write).
 - Altera√ß√µes s√£o feitas apenas na camada superior.
- **Camadas**:
  - **Lowerdir**: Camada de leitura (read-only).
  - **Upperdir**: Camada de escrita (read-write).
  - **Workdir**: Diret√≥rio tempor√°rio usado internamente pelo OverlayFS.
  - **Merged**: Vis√£o unificada das camadas.

## Funcionamento B√°sico
- Arquivos e diret√≥rios no `upperdir` sobrescrevem os arquivos equivalentes no `lowerdir`.
- Arquivos exclu√≠dos s√£o "marcados" no `upperdir` como inexistentes, mas permanecem fisicamente no `lowerdir`.

# 2. Configurando o OverlayFS
## 2.1 Pr√©-requisitos
Certifique-se de que o suporte ao OverlayFS est√° habilitado no kernel:

bash
```
cat /proc/filesystems | grep overlay
```
Se `overlay` aparecer na sa√≠da, o sistema suporta OverlayFS.

## 2.2 Estrutura de Diret√≥rios para o Exemplo
1. Crie os diret√≥rios necess√°rios:

bash
```
mkdir -p /overlay/lowerdir
mkdir -p /overlay/upperdir
mkdir -p /overlay/workdir
mkdir -p /overlay/merged
```
2. Adicione arquivos ao **lowerdir**:

bash
```
echo "Arquivo original" > /overlay/lowerdir/original.txt
echo "Outro arquivo" > /overlay/lowerdir/outro.txt
```
3. Deixe `upperdir` e `workdir` vazios.

## 2.3 Montando o OverlayFS
Use o comando `mount` para configurar o OverlayFS:

bash
```
sudo mount -t overlay overlay -o lowerdir=/overlay/lowerdir,upperdir=/overlay/upperdir,workdir=/overlay/workdir /overlay/merged
```
Agora, o diret√≥rio `/overlay/merged` exibe os arquivos combinados das camadas.

## 2.4 Verificando o Overlay
1. Liste os arquivos no diret√≥rio `merged`:

bash
```
ls /overlay/merged
```
### Sa√≠da esperada:

```
original.txt
outro.txt
```
2. Adicione um arquivo √† camada superior (`upperdir`):

bash
```
echo "Arquivo novo" > /overlay/merged/novo.txt
```
3. Liste novamente os arquivos em `merged`:

bash
```
ls /overlay/merged
```
### Sa√≠da esperada:

```
original.txt
outro.txt
novo.txt
```
4. Verifique onde o arquivo foi armazenado:

bash
```
ls /overlay/upperdir
```
### Sa√≠da esperada:

```
novo.txt
```
## 2.5 Excluindo Arquivos
1. Exclua um arquivo do diret√≥rio `merged`:

bash
```
rm /overlay/merged/original.txt
```
2. Verifique novamente os arquivos em `merged`:

bash
```
ls /overlay/merged
```
### Sa√≠da esperada:

```
outro.txt
novo.txt
```
3. Verifique o `upperdir`:

bash
```
ls /overlay/upperdir
```
### Sa√≠da esperada:

```
novo.txt
whiteout_original.txt
```
- `whiteout_original.txt`: Indica que o arquivo foi "exclu√≠do" da camada superior.

# 3. OverlayFS no Docker
## 3.1 Uso no Docker
- O Docker usa OverlayFS para criar camadas de imagens.
- Cada instru√ß√£o em um **Dockerfile** (RUN, COPY, ADD) gera uma nova camada.
- As camadas s√£o combinadas com OverlayFS para criar o sistema de arquivos final.

### Comando para Verificar o Uso de OverlayFS
Para verificar se o Docker est√° usando OverlayFS:

bash
```
docker info | grep Storage
```
### Sa√≠da esperada:

yaml
```
Storage Driver: overlay2
```
## 3.2 Visualizando Camadas de Imagem
1. Liste as imagens Docker:

bash
```
docker images
```
2. Inspecione uma imagem para ver suas camadas:

bash
```
docker inspect <image_id>
```
3. Verifique o hist√≥rico de camadas:

bash
```
docker history <image_id>
```
# 4. Vantagens do OverlayFS
1. **Efici√™ncia de Armazenamento**:
- Camadas read-only s√£o compartilhadas entre cont√™ineres.
- Somente altera√ß√µes espec√≠ficas ocupam espa√ßo adicional.

2. **Desempenho**:
- Reduz a duplica√ß√£o de dados.
- R√°pido para criar ou remover cont√™ineres.

3. **Flexibilidade**:
- Permite rollback e reutiliza√ß√£o de camadas.

# 5. Limita√ß√µes e Considera√ß√µes
1. **Compatibilidade**:
- Requer suporte no kernel (Linux 3.18 ou superior recomendado).

2. **Limita√ß√µes em Diret√≥rios Compartilhados**:
- Alguns sistemas de arquivos (ex.: NFS) podem n√£o funcionar corretamente com OverlayFS.

3. **Restri√ß√µes de Escrita**:
- Altera√ß√µes s√£o sempre feitas no `upperdir`, nunca no `lowerdir`.

# 6. Limpando o OverlayFS
1. Desmonte o sistema de arquivos:

bash
```
sudo umount /overlay/merged
```
2. Exclua os diret√≥rios criados (opcional):

bash
```
rm -rf /overlay
```
# 7. Conclus√£o
O OverlayFS √© uma tecnologia essencial para sistemas que precisam combinar camadas de arquivos de forma eficiente, como o Docker. Ele permite criar ambientes flex√≠veis e otimizados para desenvolvimento e produ√ß√£o. Testar OverlayFS manualmente ajuda a entender como ele funciona nos bastidores, facilitando o trabalho com cont√™ineres e sistemas baseados em camadas.

Se precisar de ajuda com configura√ß√µes espec√≠ficas ou integra√ß√£o com Docker, √© s√≥ pedir! üòä