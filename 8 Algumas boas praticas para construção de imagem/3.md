# Boas Pr√°ticas para Constru√ß√£o de Imagens Docker: Otimizar Sempre a Sua Imagem
Otimizar imagens Docker √© crucial para melhorar o desempenho, reduzir o uso de recursos e facilitar o gerenciamento. Uma imagem bem otimizada ser√° menor, mais r√°pida de construir, transportar e mais eficiente em produ√ß√£o.

# 1. Benef√≠cios de Imagens Otimizadas
1. **Tamanhos Menores**:
- Reduz o tempo de download e upload.
- Menor impacto no armazenamento.

2. **Constru√ß√£o Mais R√°pida**:
- Menos camadas e depend√™ncias resultam em builds mais r√°pidos.

3. **Seguran√ßa**:
- Imagens menores e minimalistas reduzem superf√≠cies de ataque.

4. **Performance Melhorada**:
- Processos mais leves no tempo de execu√ß√£o.

5. **Facilidade de Distribui√ß√£o**:
- Imagens pequenas e eficientes s√£o mais f√°ceis de distribuir em clusters ou m√∫ltiplos ambientes.

# 2. Boas Pr√°ticas para Otimizar Imagens Docker
## 2.1 Use Imagens Base Minimalistas
Prefira imagens minimalistas como **Alpine Linux** sempre que poss√≠vel. Elas s√£o leves e possuem apenas o essencial.

### Exemplo:

dockerfile
```
FROM node:16-alpine
```
- A imagem `node:16-alpine` tem cerca de **5 MB**, enquanto `node:16` pode ultrapassar **1 GB**.

## 2.2 Combine Comandos para Reduzir Camadas
Cada instru√ß√£o no Dockerfile cria uma nova camada na imagem. Combine comandos para evitar a cria√ß√£o de camadas desnecess√°rias.

### Exemplo Ruim:

dockerfile
```
RUN apt-get update
RUN apt-get install -y curl
RUN rm -rf /var/lib/apt/lists/*
```
### Exemplo Otimizado:

dockerfile
```
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
```

## 2.3 Exclua Arquivos Desnecess√°rios
Remova arquivos tempor√°rios, caches ou dados que n√£o ser√£o usados no cont√™iner final.

Exemplo:

dockerfile
```
RUN apt-get update && apt-get install -y curl \
    && rm -rf /var/lib/apt/lists/*
```
## 2.4 Use `.dockerignore`
Crie um arquivo `.dockerignore` para excluir arquivos desnecess√°rios do contexto de build, como logs, depend√™ncias locais ou arquivos de configura√ß√£o.

**Exemplo de** `.dockerignore`:

bash
```
node_modules
*.log
.git
Dockerfile
```
## 2.5 Utilize Multistage Builds
O **Multistage Build** √© uma t√©cnica poderosa para criar imagens otimizadas. Ela permite separar o processo de build (com depend√™ncias pesadas) do cont√™iner final (minimalista).

### Exemplo:

dockerfile
```
# Etapa 1: Build
FROM node:16 AS build
WORKDIR /app
COPY package.json ./
RUN npm install
COPY . .
RUN npm run build

# Etapa 2: Cont√™iner Final
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
```
Resultado:
- Apenas os arquivos necess√°rios (diret√≥rio dist) s√£o inclu√≠dos na imagem final.

## 2.6 Especifique Apenas o Essencial em COPY
Evite copiar todo o diret√≥rio se apenas alguns arquivos forem necess√°rios.

Exemplo Ruim:

dockerfile
```
COPY . /app
```
### Exemplo Otimizado:

dockerfile
```
COPY package.json package-lock.json /app
RUN npm install
COPY . .
```
## 2.7 Prefira `CMD` ao Inv√©s de `RUN` para Processos de Execu√ß√£o
O `CMD` define o comando que ser√° executado no cont√™iner no momento de sua inicializa√ß√£o. Evite usar RUN para comandos que devem ser executados apenas em runtime.

### Exemplo Otimizado:

dockerfile
```
CMD ["node", "server.js"]
```
## 2.8 Evite Executar Como Root
Adicione um usu√°rio n√£o privilegiado para aumentar a seguran√ßa e evitar que processos no cont√™iner tenham acesso desnecess√°rio.

### Exemplo:

dockerfile
```
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser
```
## 2.9 Use Vari√°veis de Ambiente com Modera√ß√£o
Defina vari√°veis de ambiente no Dockerfile apenas para valores que realmente precisam ser persistidos.

Exemplo:

dockerfile
```
ENV NODE_ENV=production
```
## 2.10 Sempre Fixe Vers√µes de Depend√™ncias
Evite usar tags gen√©ricas como `latest`, pois podem causar inconsist√™ncias em builds futuros.

### Exemplo:

dockerfile
```
FROM python:3.9-slim
RUN pip install flask==2.2.0
```
## 2.11 Remova Depend√™ncias de Build
Depend√™ncias usadas apenas no processo de constru√ß√£o devem ser removidas da imagem final.

Exemplo:

dockerfile
```
RUN apt-get update && apt-get install -y build-essential \
    && pip install -r requirements.txt \
    && apt-get remove -y build-essential && apt-get autoremove -y
```
## 2.12 Digitalize Imagens para Vulnerabilidades
Use ferramentas de digitaliza√ß√£o para identificar e corrigir vulnerabilidades.

### Ferramentas Populares:

- **Docker Scan**:

bash
```
docker scan <imagem>
```
- **Trivy**:

bash
```
trivy image <imagem>
```
## 2.13 Use `EXPOSE` para Limitar Portas
Declare apenas as portas necess√°rias no Dockerfile para melhorar a seguran√ßa e facilitar a documenta√ß√£o.

### Exemplo:

dockerfile
```
EXPOSE 8080
```
# 3. Ferramentas para Otimizar Imagens
1. **Dive**:
- Ferramenta para inspecionar camadas de imagens e identificar desperd√≠cios.
- Instala√ß√£o:

bash
```
brew install dive
```
- **Uso**:

bash
```
dive <imagem>
```
2. **Trivy**:
- Digitaliza√ß√£o de vulnerabilidades em imagens Docker.
- Instala√ß√£o:

bash
```
brew install aquasecurity/trivy/trivy
```
- Uso:

bash
```
trivy image <imagem>
```
# 4. Exemplo Completo de Dockerfile Otimizado
## Dockerfile:

dockerfile
```
# Imagem Base Minimalista
FROM node:16-alpine AS build

# Definir Diret√≥rio de Trabalho
WORKDIR /app

# Copiar Apenas Arquivos Necess√°rios para o Build
COPY package.json package-lock.json ./
RUN npm install

# Copiar C√≥digo-Fonte e Criar Build
COPY . .
RUN npm run build

# Imagem Final com Nginx
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html

# Expor Porta
EXPOSE 80

# Comando de Execu√ß√£o
CMD ["nginx", "-g", "daemon off;"]
```
# 5. Conclus√£o
Imagens Docker otimizadas s√£o mais r√°pidas, seguras e f√°ceis de gerenciar. Ao seguir estas boas pr√°ticas, voc√™ pode criar imagens eficientes para qualquer projeto.

## Resumo de Boas Pr√°ticas:
- Use imagens base minimalistas.
- Combine comandos para reduzir camadas.
- Exclua arquivos tempor√°rios e use `.dockerignore`.
- Adote Multistage Builds para separar processos.
- Digitalize imagens regularmente para identificar vulnerabilidades.
Se precisar de mais exemplos ou ajuda para otimizar suas imagens, √© s√≥ chamar! üöÄüòä