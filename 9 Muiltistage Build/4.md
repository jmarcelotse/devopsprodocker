# Usando Imagem Externa no Multistage Build
O **Multistage Build** no Docker permite que voc√™ combine imagens externas em diferentes est√°gios, o que √© √∫til quando voc√™ precisa de uma imagem base espec√≠fica para um est√°gio (como ferramentas de build ou runtime especializado) e outra para o runtime final.

# 1. Cen√°rio Comum: Compilador e Runtime Separados
Imagens externas podem ser usadas para:

- **Est√°gio de Build**: Usar uma imagem com ferramentas espec√≠ficas para compilar o c√≥digo.
- **Est√°gio de Produ√ß√£o**: Usar uma imagem m√≠nima (como Alpine) para executar o bin√°rio gerado.

# 2. Exemplo Pr√°tico: Aplica√ß√£o Go
Neste exemplo, usamos uma imagem externa para compilar um aplicativo em Go e outra imagem minimalista para executar o bin√°rio gerado.

## Estrutura do Projeto
go
```
multistage-go/
‚îÇ
‚îú‚îÄ‚îÄ main.go
‚îú‚îÄ‚îÄ Dockerfile
```
## main.go:

go
```
package main

import (
	"fmt"
	"net/http"
)

func handler(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintf(w, "Ol√°, Multistage Build com Imagens Externas!")
}

func main() {
	http.HandleFunc("/", handler)
	fmt.Println("Servidor rodando na porta 8080")
	http.ListenAndServe(":8080", nil)
}
```
## Dockerfile
dockerfile
```
# Etapa 1: Build
FROM golang:1.18 AS build
WORKDIR /app

# Copiar o c√≥digo e compilar
COPY main.go .
RUN go build -o main main.go

# Etapa 2: Produ√ß√£o
FROM alpine:3.15 AS production
WORKDIR /app

# Copiar o bin√°rio gerado para a imagem final
COPY --from=build /app/main .

# Definir o comando padr√£o
CMD ["./main"]
```
## Passos no Terminal
1. **Construir a Imagem**:

bash
```
docker build -t multistage-go .
```
2. **Executar o Cont√™iner**:

bash
```
docker run -d -p 8080:8080 multistage-go
```
3. **Testar no Navegador ou via Curl**:
- URL: http://localhost:8080
- Comando:

bash
```
curl http://localhost:8080
```
### Sa√≠da:

css
```
Ol√°, Multistage Build com Imagens Externas!
```
# 3. Exemplo Pr√°tico: Aplica√ß√£o Python
Agora, vamos usar uma imagem com ferramentas de build e outra para execu√ß√£o com Python.

## Estrutura do Projeto
```
multistage-python/
‚îÇ
‚îú‚îÄ‚îÄ app.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ Dockerfile
```
### app.py:

python
```
from flask import Flask

app = Flask(__name__)

@app.route("/")
def home():
    return "Ol√°, Multistage Build com Python!"

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
```
### requirements.txt:

```
flask
```
## Dockerfile
dockerfile
```
# Etapa 1: Build
FROM python:3.10-slim AS build
WORKDIR /app

# Instalar depend√™ncias em uma imagem de build
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Etapa 2: Produ√ß√£o
FROM python:3.10-alpine AS production
WORKDIR /app

# Copiar arquivos necess√°rios
COPY --from=build /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY app.py .

# Executar a aplica√ß√£o
CMD ["python", "app.py"]
```
## Passos no Terminal
1. **Construir a Imagem**:

bash
```
docker build -t multistage-python .
```
2. **Executar o Cont√™iner**:

bash
```
docker run -d -p 5000:5000 multistage-python
```
3. **Testar no Navegador ou via Curl**:
- URL: http://localhost:5000
- Comando:

bash
```
curl http://localhost:5000
```
### Sa√≠da:

css
```
Ol√°, Multistage Build com Python!
```
# 4. Boas Pr√°ticas para Usar Imagens Externas
## 4.1 Especifique Vers√µes Fixas
Evite usar `latest`, pois isso pode causar inconsist√™ncias.

Exemplo:

dockerfile
```
FROM golang:1.18
FROM alpine:3.15
```
## 4.2 Use Imagens Minimalistas no Est√°gio Final
Imagens como **Alpine** reduzem o tamanho e aumentam a seguran√ßa.

Exemplo:

dockerfile
```
FROM alpine:3.15
```
## 4.3 Combine com .dockerignore
Exclua arquivos desnecess√°rios para acelerar o build.

**Exemplo de `.dockerignore`**:

bash
```
*.log
.git
node_modules
```
## 4.4 Teste os Est√°gios com --target
Construa at√© est√°gios intermedi√°rios para depura√ß√£o:

bash
```
docker build --target build -t debug-build .
```
## 4.5 Use Ferramentas de Digitaliza√ß√£o
Digitalize imagens externas para garantir seguran√ßa.

### Exemplo com Trivy:

bash
```
trivy image golang:1.18
```
# 5. Conclus√£o
O uso de imagens externas no **Multistage Build** permite criar imagens otimizadas e espec√≠ficas para diferentes necessidades, como compila√ß√£o e execu√ß√£o. Essa abordagem reduz o tamanho das imagens, melhora a seguran√ßa e simplifica o gerenciamento.

## Resumo de Benef√≠cios:
1. Separa√ß√£o de responsabilidades entre build e execu√ß√£o.
2. Imagens finais menores e mais seguras.
Maior flexibilidade ao usar imagens externas especializadas.
Se precisar de ajuda para integrar imagens externas no seu Multistage Build, √© s√≥ chamar! üöÄüòä