# Multistage Build no Docker
O **Multistage Build** √© uma t√©cnica poderosa no Docker que permite criar imagens leves e otimizadas, separando as etapas de constru√ß√£o e execu√ß√£o. Com ele, voc√™ pode usar v√°rias imagens base dentro de um √∫nico Dockerfile, extraindo apenas o que √© necess√°rio para a imagem final.

# 1. O Que √© Multistage Build?
- **Separa√ß√£o de Etapas**:
   - Divide o processo de constru√ß√£o em est√°gios.
- **Imagem Final Leve**:
   - Apenas os arquivos essenciais s√£o inclu√≠dos na imagem final.
- **Ideal para Builds Complexos**:
   - Ferramentas de build (compiladores, depend√™ncias pesadas) ficam fora da imagem final.

# 2. Por Que Usar Multistage Build?
1. **Imagens Mais Leves**:
   - A imagem final cont√©m apenas os arquivos necess√°rios.
2. **Melhoria na Seguran√ßa**:
   - Depend√™ncias e ferramentas de build n√£o ficam na imagem de produ√ß√£o.
3. **Processo de Build Modular**:
   - Cada est√°gio do build pode ser tratado separadamente.
4. **Redu√ß√£o de Tamanho e Complexidade**:
   - Imagens menores consomem menos espa√ßo e s√£o mais r√°pidas para distribuir.

# 3. Estrutura B√°sica de um Multistage Build
Um Dockerfile com Multistage Build cont√©m m√∫ltiplas **imagens base** ou **est√°gios**, referenciados por **aliases**.

## Exemplo de Estrutura
dockerfile
```
# Etapa 1: Build
FROM node:16 AS build
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
RUN npm run build

# Etapa 2: Imagem Final
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```
# 4. Como Funciona?
## 4.1 Est√°gio de Build
- Usa uma imagem base com ferramentas de build.
- Compila ou processa arquivos.
- Produz um diret√≥rio ou artefato que ser√° usado no pr√≥ximo est√°gio.
## 4.2 Est√°gio Final
- Usa uma imagem m√≠nima (como Alpine ou Debian Slim).
- Copia apenas os arquivos necess√°rios do est√°gio anterior.
- Cria o cont√™iner final para produ√ß√£o.

# 5. Exemplo Completo
## 5.1 Aplica√ß√£o Node.js com Nginx
### Dockerfile:

dockerfile
```
# Etapa 1: Build
FROM node:16 AS build
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
RUN npm run build

# Etapa 2: Imagem Final
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```
**Passos**:

1. Na primeira etapa:
   - A aplica√ß√£o √© instalada e constru√≠da.
2. Na segunda etapa:
   - Apenas os arquivos da pasta dist s√£o copiados para o servidor Nginx.

## 5.2 Aplica√ß√£o Go
### Dockerfile:

dockerfile
```
# Etapa 1: Build
FROM golang:1.18 AS build
WORKDIR /app
COPY . .
RUN go build -o main .

# Etapa 2: Imagem Final
FROM alpine:3.15
WORKDIR /app
COPY --from=build /app/main .
CMD ["./main"]
```
### Explica√ß√£o:

- O primeiro est√°gio compila o bin√°rio Go.
- O segundo est√°gio usa **Alpine**, uma imagem minimalista, para executar o bin√°rio.

## 5.3 Aplica√ß√£o Python
### Dockerfile:

dockerfile
```
# Etapa 1: Build
FROM python:3.10-slim AS build
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .

# Etapa 2: Imagem Final
FROM python:3.10-alpine
WORKDIR /app
COPY --from=build /app .
CMD ["python", "app.py"]
```
### Explica√ß√£o:

- As depend√™ncias s√£o instaladas na etapa de build.
- Apenas os arquivos necess√°rios s√£o copiados para a imagem final.

# 6. Boas Pr√°ticas no Multistage Build
## 6.1 Use Aliases Descritivos
D√™ nomes significativos aos est√°gios para facilitar a leitura e manuten√ß√£o.

dockerfile
```
FROM node:16 AS build-stage
FROM nginx:alpine AS production-stage
```
## 6.2 Limite Arquivos Copiados
Copie apenas os arquivos necess√°rios entre os est√°gios.

dockerfile
```
COPY --from=build /app/dist /usr/share/nginx/html
```
## 6.3 Combine com `.dockerignore`
Exclua arquivos desnecess√°rios do contexto de build.

### Exemplo de `.dockerignore`:

bash
```
node_modules
*.log
.git
```
## 6.4 Prefira Imagens Base Minimalistas
Use imagens leves para o est√°gio final.

### Exemplo:

dockerfile
```
FROM alpine:3.15
```
## 6.5 Digitalize Imagens
Verifique vulnerabilidades nas imagens usadas em cada est√°gio.

### Exemplo com Trivy:

bash
```
trivy image <nome-da-imagem>
```
## 6.6 Evite Etapas de Build Excessivas
Mantenha o n√∫mero de est√°gios o mais baixo poss√≠vel para simplificar o processo.

# 7. Vantagens do Multistage Build
| Aspecto                   | Comum                                | Multistage Build                   |
| ------------------------- | ------------------------------------ | ---------------------------------- |
| Tamanho da Imagem         | Maior (cont√©m ferramentas de build). | Menor (cont√©m apenas o essencial). |
| Separa√ß√£o de Preocupa√ß√µes | Limitada.                            | Completa.                          |
| Manuten√ß√£o                | Mais complexa.                       | Mais simples.                      |
| Reutiliza√ß√£o de Artefatos | Dif√≠cil.                             | Natural (entre est√°gios).          |

# 8. Cen√°rios Comuns para Multistage Build
1. **Aplica√ß√µes com Build Pesado**:
   - Projetos Node.js, Angular, React, ou Go.
2. **Servi√ßos com Artefatos Est√°ticos**:
   - Sites est√°ticos ou APIs.
3. **Ambientes Multi-Linguagem**:
   - Quando o processo de build requer linguagens ou ferramentas diferentes do runtime.

# 9. Exemplo Avan√ßado com Testes
## Dockerfile:

dockerfile
```
# Etapa 1: Build
FROM node:16 AS build
WORKDIR /app
COPY package.json .
RUN npm install
COPY . .
RUN npm run build

# Etapa 2: Testes
FROM build AS test
RUN npm run test

# Etapa 3: Produ√ß√£o
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```
## Explica√ß√£o:
- A segunda etapa executa os testes.
- Apenas se os testes passarem, a imagem de produ√ß√£o ser√° constru√≠da.

# 10. Conclus√£o
O Multistage Build √© uma t√©cnica essencial para criar imagens Docker otimizadas e seguras. Ele reduz o tamanho da imagem, melhora a separa√ß√£o de responsabilidades e elimina ferramentas de build desnecess√°rias do runtime.

## Resumo de Boas Pr√°ticas:
1. Divida o processo de build em **est√°gios l√≥gicos**.
2. Use imagens base **minimalistas** no est√°gio final.
3. Copie apenas o necess√°rio entre est√°gios.
4. Combine o Multistage Build com `.dockerignore`.
5. Digitalize imagens para garantir seguran√ßa.

Se precisar de ajuda para implementar um Multistage Build no seu projeto, √© s√≥ chamar! üöÄüòä